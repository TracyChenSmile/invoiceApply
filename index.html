<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電子發票請款系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar for Telerik-like feel */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. Icons ---
        const IconBase = ({ size = 24, className = "", children, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            FileSpreadsheet: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            Filter: (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            Pencil: (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>,
            DollarSign: (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            ChevronDown: (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>,
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            ListFilter: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 7h4"/></IconBase>,
            Loader2: (p) => <IconBase {...p} className={`${p.className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            ShieldCheck: (p) => <IconBase {...p}><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></IconBase>,
            Ban: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></IconBase>
        };

        // --- 2. Gemini API Helper ---
        const callGemini = async (prompt, systemPrompt = "", jsonMode = true) => {
            const apiKey = ""; // 【請在此填入您的 API Key】
            if (!apiKey) {
                console.warn("未設定 API Key，將回傳模擬資料。");
                if (jsonMode && prompt.includes("Audit")) {
                    return new Promise(r => setTimeout(() => r({ safe: true, warnings: ["模擬: 金額正常", "模擬: 匯率符合"] }), 1000));
                }
                if (jsonMode && prompt.includes("Extract")) {
                    return new Promise(r => setTimeout(() => r({ items: [{ item: "模擬項目", qty: 1, unitPrice: 1000, currency: "TWD" }] }), 1000));
                }
                return null;
            }

            try {
                const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined,
                    generationConfig: jsonMode ? { responseMimeType: "application/json" } : undefined
                    }),
                }
                );
                if (!response.ok) return null;
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return jsonMode && text ? JSON.parse(text) : text;
            } catch (e) {
                console.error("Gemini Error", e);
                return null;
            }
        };

        // --- 3. Constants & Mock Data ---
        const MOCK_CUSTOMERS = ["台灣積體電路製造 (TSMC)", "聯發科技 (MediaTek)", "鴻海精密 (Foxconn)", "廣達電腦 (Quanta)"];
        const MOCK_PROJECTS = ["P2025-001 AI Server 建置案", "P2025-002 雲端遷移專案", "P2025-003 資安維護合約"];
        const MOCK_SALES_ITEMS = ["Consulting Fee", "Server License", "Annual Maintenance", "Professional Services"];
        const MOCK_POS = ["PO-TSMC-01", "PO-MTK-99", "PO-FOX-05", "PO-QTA-22"];
        const MOCK_SALESPEOPLE = ["Alice", "Bob", "Charlie", "David"];

        const CURRENCIES = ["TWD", "USD", "JPY", "EUR"];
        const INVOICE_REGIONS = ["國內發票 (Domestic)", "國外發票 (Foreign)"];
        const INVOICE_PURPOSES = ["存證發票 (Evidence)", "交換發票 (Exchange)"];
        const TRANSACTION_TYPES = ["出口 (Export)", "非出口 (Non-Export)"];
        const TAX_CATEGORIES = ["應稅 (Taxable)", "零稅率 (Zero Rated)", "免稅 (Exempt)"];

        const STATUS_MAP = {
            1: { label: "草稿", color: "bg-gray-500", text: "Draft" },
            3: { label: "審查中", color: "bg-yellow-500", text: "Reviewing" },
            4: { label: "退回", color: "bg-red-500", text: "Returned" },
            5: { label: "作廢待確認", color: "bg-orange-500", text: "Void Pending" },
            6: { label: "作廢確認", color: "bg-gray-800", text: "Void Confirmed" },
            7: { label: "完成", color: "bg-green-600", text: "Completed" }
        };

        const INITIAL_DATA = [
            {
                id: "req-001",
                formNumber: "INV-20250113-001",
                status: 3, 
                invoiceDate: "2025-01-13",
                customerName: "台灣積體電路製造 (TSMC)",
                invoiceRegion: "國內發票 (Domestic)",
                memo: "急件處理",
                items: [
                { 
                    id: 1, 
                    project: "P2025-001 AI Server 建置案", 
                    workOrder: "WO-2025-001", 
                    po: "PO-TSMC-01", 
                    shipNo: "SH-250101", 
                    item: "Consulting Fee", 
                    currency: "USD", qty: 10, unitPrice: 200, twdPrice: 6500, subtotal: 65000,
                    transactionType: "非出口 (Non-Export)", salesperson: "Alice", salesMemo: "第一期款",
                    taxCategory: "應稅 (Taxable)", taxRate: 5, financeMemoToSales: "", financeMemo: ""
                }
                ],
                finance: { invoiceNo: "", invoicePurpose: "存證發票 (Evidence)", revenueDate: "", buyerNote: "" }
            }
        ];

        // --- 4. Telerik Simulation Components ---

        const TelerikButton = ({ children, onClick, icon: Icon, themeColor = "base", className = "", disabled = false, ...props }) => {
            const colorMap = {
                base: "bg-gray-100 text-gray-700 hover:bg-gray-200 border-gray-300",
                primary: "bg-[#3D57AD] text-white hover:bg-[#2F448A] border-[#3D57AD]",
                success: "bg-[#357D55] text-white hover:bg-[#2A6343] border-[#357D55]",
                warning: "bg-[#FFC107] text-black hover:bg-[#E0A800] border-[#FFC107]",
                error: "bg-[#E14233] text-white hover:bg-[#C9302C] border-[#E14233]",
                info: "bg-blue-100 text-blue-800 hover:bg-blue-200 border-blue-200",
                inverse: "bg-gray-800 text-white hover:bg-gray-900 border-gray-800"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded text-sm font-medium border shadow-sm transition-all flex items-center gap-2 ${colorMap[themeColor] || colorMap.base} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`} {...props}>
                {Icon && <Icon size={16} />} {children}
                </button>
            );
        };

        const TelerikTextBox = ({ value, valueChanged, label, placeholder, enabled = true, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                {label && <label className="text-xs font-semibold text-gray-500 mb-1">{label}</label>}
                <input type="text" value={value || ""} onChange={(e) => valueChanged && valueChanged(e.target.value)} disabled={!enabled} placeholder={placeholder} className={`w-full px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-[#3D57AD] outline-none ${!enabled ? 'bg-gray-100 text-gray-500' : 'bg-white'}`} />
            </div>
        );

        const TelerikTextArea = ({ value, valueChanged, label, rows = 3, enabled = true }) => (
            <div className="flex flex-col w-full">
                {label && <label className="text-xs font-semibold text-gray-500 mb-1">{label}</label>}
                <textarea value={value || ""} onChange={(e) => valueChanged && valueChanged(e.target.value)} disabled={!enabled} rows={rows} className={`w-full px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-[#3D57AD] outline-none resize-none ${!enabled ? 'bg-gray-100 text-gray-500' : 'bg-white'}`} />
            </div>
        );

        const TelerikDropDownList = ({ data, value, valueChanged, label, defaultText, enabled = true, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                {label && <label className="text-xs font-semibold text-gray-500 mb-1">{label}</label>}
                <div className="relative">
                <select value={value || ""} onChange={(e) => valueChanged && valueChanged(e.target.value)} disabled={!enabled} className={`w-full px-3 py-2 text-sm border rounded appearance-none focus:ring-2 focus:ring-[#3D57AD] outline-none ${!enabled ? 'bg-gray-100 text-gray-500' : 'bg-white'}`}>
                    {defaultText && <option value="">{defaultText}</option>}
                    {data.map((item, idx) => <option key={idx} value={item}>{item}</option>)}
                </select>
                <div className="absolute right-3 top-2.5 pointer-events-none text-gray-400"><Icons.ChevronDown size={14} /></div>
                </div>
            </div>
        );

        const TelerikDatePicker = ({ value, valueChanged, label, enabled = true, className = "" }) => (
            <div className={`flex flex-col ${className}`}>
                {label && <label className="text-xs font-semibold text-gray-500 mb-1">{label}</label>}
                <input type="date" value={value || ""} onChange={(e) => valueChanged && valueChanged(e.target.value)} disabled={!enabled} className={`w-full px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-[#3D57AD] outline-none ${!enabled ? 'bg-gray-100 text-gray-500' : 'bg-white'}`} />
            </div>
        );

        const TelerikWindow = ({ visible, title, onClose, children, footer, width = "800px" }) => {
            if (!visible) return null;
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px] z-50 flex items-center justify-center p-4">
                <div 
                    className="bg-white rounded shadow-2xl flex flex-col max-h-[90vh] w-full animate-in fade-in zoom-in duration-200 border border-gray-200" 
                    style={{ maxWidth: width }}
                >
                    <div className="flex justify-between items-center px-4 py-2 bg-[#F8F9FA] border-b border-gray-300 rounded-t text-[#495057] shrink-0">
                    <span className="font-semibold text-sm select-none">{title}</span>
                    <button onClick={onClose} className="hover:bg-gray-200 p-1 rounded transition-colors text-gray-500"><Icons.X size={18} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 min-h-0">{children}</div>
                    {footer && <div className="p-4 border-t border-gray-200 bg-[#F8F9FA] rounded-b flex justify-end gap-2 shrink-0">{footer}</div>}
                </div>
                </div>
            );
        };

        const TelerikGrid = ({ data, columns, onRowClick, toolbar }) => (
            <div className="border border-gray-300 rounded bg-white flex flex-col h-full shadow-sm">
                {toolbar && <div className="p-2 border-b border-gray-200 bg-[#F8F9FA] flex gap-2 items-center">{toolbar}</div>}
                <div className="bg-[#E9ECEF] px-4 py-2 text-xs text-gray-500 border-b border-gray-300 flex items-center gap-2 select-none"><Icons.Filter size={12} /> Drag a column header and drop it here to group by that column</div>
                <div className="overflow-auto flex-1">
                <table className="w-full text-sm text-left border-collapse">
                    <thead className="bg-[#F8F9FA] text-[#495057] font-semibold sticky top-0 z-10 shadow-sm">
                    <tr>{columns.map((col, idx) => <th key={idx} className={`px-4 py-3 border-b border-gray-300 whitespace-nowrap ${col.className || ''}`} style={{ width: col.width }}>{col.title}</th>)}</tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                    {data.length === 0 ? <tr><td colSpan={columns.length} className="p-8 text-center text-gray-400 italic">No records available.</td></tr> : data.map((item, rowIdx) => (
                        <tr key={item.id || rowIdx} className={`hover:bg-blue-50/50 transition-colors ${onRowClick ? 'cursor-pointer' : ''}`} onClick={() => onRowClick && onRowClick(item)}>
                        {columns.map((col, colIdx) => <td key={colIdx} className={`px-4 py-2 border-r border-transparent ${col.className || ''}`}>{col.cell ? col.cell(item) : item[col.field]}</td>)}
                        </tr>
                    ))}
                    </tbody>
                </table>
                </div>
            </div>
        );

        function SmartPasteModal({ onClose, onConfirm }) {
            const [text, setText] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const handleParse = async () => {
                if (!text.trim()) return;
                setIsLoading(true);
                const systemPrompt = `Extract invoice line items from text to JSON. Keys: project, item, qty, unitPrice, currency, po.`;
                const result = await callGemini(text, systemPrompt, true);
                setIsLoading(false);
                if (result && result.items) onConfirm(result.items); else alert("AI 解析失敗");
            };
            return (
                <TelerikWindow visible={true} title="✨ AI 智慧匯入" width="500px" onClose={onClose} footer={<><TelerikButton onClick={onClose}>取消</TelerikButton><TelerikButton themeColor="primary" onClick={handleParse} disabled={isLoading || !text} icon={isLoading ? Icons.Loader2 : Icons.Sparkles}>{isLoading ? "解析中..." : "開始解析"}</TelerikButton></>}>
                <TelerikTextArea value={text} valueChanged={setText} rows={6} placeholder="請貼上內容..." />
                </TelerikWindow>
            );
        }

        // --- 5. Main Logic Components ---

        function InvoiceFormWindow({ request, role, onClose, onSave }) {
            const [formData, setFormData] = useState(request);
            const [items, setItems] = useState(request.items);
            const [errors, setErrors] = useState([]);
            const [showSmartPaste, setShowSmartPaste] = useState(false);
            const [isAuditing, setIsAuditing] = useState(false);
            const [auditResult, setAuditResult] = useState(null);
            const [showReturnDialog, setShowReturnDialog] = useState(false);
            const [showVoidDialog, setShowVoidDialog] = useState(false);
            const [returnReason, setReturnReason] = useState("");
            const [voidReason, setVoidReason] = useState("");

            const isFinanceMode = role === 'finance';
            const isReviewing = formData.status === 3;
            const isCompleted = formData.status === 7;
            const isVoidPending = formData.status === 5;
            const canSalesEdit = role === 'sales' && (formData.status === 1 || formData.status === 4);
            const canFinanceAction = isFinanceMode && isReviewing;
            const canFinanceRequestVoid = isFinanceMode && isCompleted; 
            const canFinanceConfirmVoid = isFinanceMode && isVoidPending; 
            const isGridEditable = canSalesEdit;
            
            const showFinanceSection = isFinanceMode || formData.status >= 3;
            const totalAmount = items.reduce((sum, item) => sum + item.subtotal, 0);

            // Auto-fill Revenue Date
            useEffect(() => {
                if (isFinanceMode && !formData.finance.revenueDate && formData.invoiceDate) {
                setFormData(prev => ({
                    ...prev,
                    finance: { ...prev.finance, revenueDate: prev.invoiceDate }
                }));
                }
            }, [isFinanceMode, formData.invoiceDate]);

            const handleItemChange = (id, field, val) => {
                setItems(prev => prev.map(item => {
                if (item.id !== id) return item;
                const updated = { ...item, [field]: val };
                if (field === 'twdPrice') {
                    updated.subtotal = Math.round(updated.twdPrice * updated.qty);
                } 
                else if (field === 'qty') {
                    updated.subtotal = Math.round(updated.twdPrice * updated.qty);
                } 
                else if (['unitPrice', 'currency'].includes(field)) {
                    if (updated.currency === 'TWD') {
                        updated.twdPrice = updated.unitPrice;
                    } 
                    updated.subtotal = Math.round(updated.twdPrice * updated.qty);
                }
                if (field === 'taxCategory') updated.taxRate = val === "應稅 (Taxable)" ? 5 : 0;
                return updated;
                }));
            };

            const addItem = () => setItems([...items, { id: Date.now(), project: "", workOrder: "", po: "", shipNo: "", item: "", currency: "TWD", qty: 1, unitPrice: 0, twdPrice: 0, subtotal: 0, transactionType: "非出口 (Non-Export)", salesperson: "", salesMemo: "", taxCategory: "應稅 (Taxable)", taxRate: 5, financeMemoToSales: "", financeMemo: "" }]);
            
            const handleSmartPasteConfirm = (newItems) => {
                const formatted = newItems.map(i => ({ id: Date.now() + Math.random(), project: i.project || "", workOrder:"", po: i.po || "", shipNo:"", item: i.item || "未命名", currency: i.currency || "TWD", qty: i.qty || 1, unitPrice: i.unitPrice || 0, twdPrice: 0, subtotal: 0, transactionType: "非出口", salesperson: "", salesMemo: "AI 匯入", taxCategory: "應稅", taxRate: 5 }));
                setItems([...items, ...formatted]); setShowSmartPaste(false);
            };

            const handleAiAudit = async () => {
                setIsAuditing(true);
                const result = await callGemini(`Audit invoice: ${JSON.stringify({customer:formData.customerName, total:totalAmount, items})}`, "", true);
                setIsAuditing(false);
                if(result) setAuditResult(result);
            };

            const handleReturnClick = () => { setReturnReason(""); setShowReturnDialog(true); };
            const confirmReturn = () => {
                if (!returnReason.trim()) { alert("請填寫退回原因"); return; }
                const updatedMemo = formData.memo ? formData.memo + `\n[退回]: ${returnReason}` : `[退回]: ${returnReason}`;
                onSave({ ...formData, memo: updatedMemo, status: 4, items });
                setShowReturnDialog(false);
            };

            const handleVoidClick = () => { setVoidReason(""); setShowVoidDialog(true); };
            const confirmVoidRequest = () => {
                if (!voidReason.trim()) { alert("請填寫作廢原因"); return; }
                const updatedMemo = formData.memo ? formData.memo + `\n[申請作廢]: ${voidReason}` : `[申請作廢]: ${voidReason}`;
                onSave({ ...formData, memo: updatedMemo, status: 5, items });
                setShowVoidDialog(false);
            };
            const handleVoidConfirm = () => onSave({ ...formData, status: 6, items });
            const handleVoidReject = () => {
                const r = prompt("駁回原因 (選填):");
                const updatedMemo = formData.memo + (r ? `\n[駁回作廢]: ${r}` : `\n[駁回作廢]`);
                onSave({ ...formData, memo: updatedMemo, status: 7, items });
            };

            const validateForm = (targetStatus) => {
                const newErrors = [];
                const isSubmitting = targetStatus === 3; 
                const isApproving = targetStatus === 7; 

                if (!formData.customerName) newErrors.push("表頭：請選擇客戶名稱");
                if (!formData.invoiceDate) newErrors.push("表頭：請選擇發票日期");
                if (!formData.invoiceRegion) newErrors.push("表頭：請選擇發票地區類型");
                if (items.length === 0) newErrors.push("明細：請至少新增一項明細");

                if (isSubmitting || isApproving) {
                    items.forEach((item, idx) => {
                        const rowPrefix = `明細第 ${idx + 1} 行`;
                        if (!item.project) newErrors.push(`${rowPrefix}：請選擇專案名稱`);
                        if (!item.item) newErrors.push(`${rowPrefix}：請選擇銷售項目`);
                        if (!item.salesperson) newErrors.push(`${rowPrefix}：請選擇負責業務`);
                        if (!item.transactionType) newErrors.push(`${rowPrefix}：請選擇交易性質`);
                        if (item.qty <= 0) newErrors.push(`${rowPrefix}：數量必須大於 0`);
                        if (item.unitPrice < 0) newErrors.push(`${rowPrefix}：單價不可為負數`);
                    });
                }

                if (isApproving) {
                    if (!formData.finance.invoiceNo) newErrors.push("財務：請填寫發票號碼");
                    if (!formData.finance.invoicePurpose) newErrors.push("財務：請選擇發票用途");
                    if (!formData.finance.revenueDate) newErrors.push("財務：請填寫營收認列日期");
                    items.forEach((item, idx) => {
                        if (!item.taxCategory) newErrors.push(`明細第 ${idx + 1} 行：請選擇稅別 (財務)`);
                    });
                }
                return newErrors;
            };

            const handleSubmit = (status) => {
                const validationErrors = validateForm(status);
                if (validationErrors.length > 0) { setErrors(validationErrors); return; }
                onSave({ ...formData, status, items });
            };

            return (
                <>
                <TelerikWindow visible={true} title={isFinanceMode ? "審核請款單" : "新增/編輯請款單"} width="1400px" onClose={onClose} footer={
                    <div className="flex justify-between w-full items-center">
                        <div className="text-lg font-bold text-gray-700">總金額: <span className="text-[#E14233]">{new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(totalAmount)}</span></div>
                        <div className="flex gap-2">
                        {canSalesEdit && <><TelerikButton onClick={() => handleSubmit(1)}>儲存草稿</TelerikButton><TelerikButton themeColor="primary" onClick={() => handleSubmit(3)} icon={Icons.ArrowUp}>送出審核</TelerikButton></>}
                        {canFinanceAction && <><TelerikButton themeColor="info" onClick={handleAiAudit} disabled={isAuditing} icon={isAuditing ? Icons.Loader2 : Icons.ShieldCheck}>{isAuditing?"稽核中...":"AI 稽核"}</TelerikButton><TelerikButton themeColor="warning" onClick={handleReturnClick} icon={Icons.RotateCcw}>退回</TelerikButton><TelerikButton themeColor="success" onClick={() => handleSubmit(7)} icon={Icons.Check}>核准</TelerikButton></>}
                        {canFinanceRequestVoid && <TelerikButton themeColor="error" onClick={handleVoidClick} icon={Icons.Ban}>申請作廢</TelerikButton>}
                        {canFinanceConfirmVoid && <><TelerikButton onClick={handleVoidReject} icon={Icons.RotateCcw}>駁回作廢</TelerikButton><TelerikButton themeColor="error" onClick={handleVoidConfirm} icon={Icons.Check}>確認作廢</TelerikButton></>}
                        <TelerikButton onClick={onClose}>取消</TelerikButton>
                        </div>
                    </div>
                    }>
                    {errors.length > 0 && <div className="bg-red-50 text-red-700 p-3 rounded mb-4 text-sm border border-red-200"><strong className="flex items-center gap-1 mb-1"><Icons.AlertCircle size={16}/> 請修正以下錯誤：</strong><ul className="list-disc list-inside">{errors.map((e,i)=><li key={i}>{e}</li>)}</ul></div>}
                    {auditResult && <div className="bg-yellow-50 text-yellow-800 p-3 mb-4 rounded border border-yellow-200"><strong>AI 稽核:</strong> {JSON.stringify(auditResult)}</div>}

                    <div className="grid grid-cols-4 gap-4 mb-6">
                    <TelerikDropDownList label="客戶名稱" data={MOCK_CUSTOMERS} value={formData.customerName} valueChanged={(v) => setFormData({...formData, customerName: v})} enabled={canSalesEdit} defaultText="請選擇..." />
                    <TelerikDatePicker label="發票日期" value={formData.invoiceDate} valueChanged={(v) => setFormData({...formData, invoiceDate: v})} enabled={canSalesEdit || canFinanceAction} />
                    <TelerikDropDownList label="發票地區類型" data={INVOICE_REGIONS} value={formData.invoiceRegion} valueChanged={(v) => setFormData({...formData, invoiceRegion: v})} enabled={canSalesEdit} />
                    <TelerikTextArea label="備註" value={formData.memo} valueChanged={(v) => setFormData({...formData, memo: v})} enabled={canSalesEdit} rows={1} />
                    </div>

                    {showFinanceSection && (
                    <div className="bg-[#FFF3CD] border border-[#FFEEBA] p-4 rounded mb-6">
                        <h4 className="text-sm font-bold text-[#856404] mb-3 flex items-center gap-2"><Icons.DollarSign size={16} /> 財務審核專區 (Finance Only)</h4>
                        <div className="grid grid-cols-4 gap-4">
                            <TelerikTextBox label="發票號碼" value={formData.finance.invoiceNo} valueChanged={(v) => setFormData({...formData, finance: {...formData.finance, invoiceNo: v}})} enabled={canFinanceAction} />
                            <TelerikDropDownList label="發票用途 (存證/交換)" data={INVOICE_PURPOSES} value={formData.finance.invoicePurpose} valueChanged={(v) => setFormData({...formData, finance: {...formData.finance, invoicePurpose: v}})} enabled={canFinanceAction} />
                            <TelerikDatePicker label="營收認列日期 (必填)" value={formData.finance.revenueDate} valueChanged={(v) => setFormData({...formData, finance: {...formData.finance, revenueDate: v}})} enabled={canFinanceAction} />
                            <TelerikTextBox label="財務註記" value={formData.finance.buyerNote} valueChanged={(v) => setFormData({...formData, finance: {...formData.finance, buyerNote: v}})} enabled={canFinanceAction} />
                        </div>
                    </div>
                    )}

                    <div className="border border-gray-300 rounded overflow-hidden flex flex-col h-[400px]">
                    <div className="bg-[#F8F9FA] p-2 border-b border-gray-300 flex justify-between items-center">
                        <span className="font-bold text-sm text-gray-700 px-2">明細項目</span>
                        {isGridEditable && <div className="flex gap-2"><TelerikButton size="sm" icon={Icons.Sparkles} themeColor="info" onClick={() => setShowSmartPaste(true)}>AI 匯入</TelerikButton><TelerikButton size="sm" icon={Icons.Plus} onClick={addItem}>新增項目</TelerikButton></div>}
                    </div>
                    <div className="overflow-auto flex-1 bg-white relative">
                        <table className="text-sm text-left border-collapse w-max">
                        <thead className="bg-[#F8F9FA] text-gray-600 font-semibold border-b border-gray-300 sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th className="p-2 w-12 sticky left-0 bg-[#F8F9FA] z-30 border-r text-center">#</th>
                                <th className="p-2 w-40 bg-blue-50/50 border-r">專案名稱 (Project)</th>
                                <th className="p-2 w-32 bg-blue-50/50 border-r">工單號碼</th>
                                <th className="p-2 w-32 bg-blue-50/50 border-r">訂單號碼 (PO)</th>
                                <th className="p-2 w-32 bg-blue-50/50 border-r">出貨單號</th>
                                <th className="p-2 w-40 bg-blue-50/50 border-r">銷售項目</th>
                                <th className="p-2 w-28 bg-blue-50/50 border-r">交易性質</th>
                                <th className="p-2 w-28 bg-blue-50/50 border-r">負責業務</th>
                                <th className="p-2 w-40 bg-blue-50/50 border-r">業助備註</th>
                                <th className="p-2 w-24 bg-blue-50/50 border-r">幣別</th>
                                <th className="p-2 w-20 bg-blue-50/50 border-r text-right">數量</th>
                                <th className="p-2 w-28 bg-blue-50/50 border-r text-right">客戶單價</th>
                                <th className="p-2 w-28 bg-blue-50/50 border-r text-right">台幣單價</th>
                                <th className="p-2 w-28 bg-yellow-50/50 border-r text-yellow-900 border-l border-yellow-200">稅別</th>
                                <th className="p-2 w-20 bg-yellow-50/50 border-r text-yellow-900 text-right">稅率%</th>
                                <th className="p-2 w-40 bg-yellow-50/50 border-r text-yellow-900">給業務備記</th>
                                <th className="p-2 w-40 bg-yellow-50/50 border-r text-yellow-900">財務備註</th>
                                <th className="p-2 w-32 text-right text-[#E14233] sticky right-0 bg-[#F8F9FA] z-30 border-l shadow-[-4px_0_4px_-2px_rgba(0,0,0,0.1)]">小計 (TWD)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                            {items.map((item, idx) => (
                            <tr key={item.id} className="hover:bg-gray-50">
                                <td className="p-2 text-center text-gray-400 sticky left-0 bg-white z-10 border-r">
                                {isGridEditable ? <button onClick={() => setItems(items.filter(i => i.id !== item.id))} className="text-gray-400 hover:text-red-500"><Icons.Trash2 size={14} /></button> : idx + 1}
                                </td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.project} onChange={e => handleItemChange(item.id, 'project', e.target.value)}><option value="">選擇...</option>{MOCK_PROJECTS.map(o=><option key={o}>{o}</option>)}</select> : item.project}</td>
                                <td className="p-2 border-r">{isGridEditable ? <input className="w-full border rounded px-1 text-xs py-1" value={item.workOrder} onChange={e => handleItemChange(item.id, 'workOrder', e.target.value)} /> : item.workOrder}</td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.po} onChange={e => handleItemChange(item.id, 'po', e.target.value)}><option value="">選擇...</option>{MOCK_POS.map(o=><option key={o}>{o}</option>)}</select> : item.po}</td>
                                <td className="p-2 border-r">{isGridEditable ? <input className="w-full border rounded px-1 text-xs py-1" value={item.shipNo} onChange={e => handleItemChange(item.id, 'shipNo', e.target.value)} /> : item.shipNo}</td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.item} onChange={e => handleItemChange(item.id, 'item', e.target.value)}><option value="">選擇...</option>{MOCK_SALES_ITEMS.map(o=><option key={o}>{o}</option>)}</select> : item.item}</td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.transactionType} onChange={e => handleItemChange(item.id, 'transactionType', e.target.value)}>{TRANSACTION_TYPES.map(o=><option key={o}>{o}</option>)}</select> : item.transactionType}</td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.salesperson} onChange={e => handleItemChange(item.id, 'salesperson', e.target.value)}><option value="">選擇...</option>{MOCK_SALESPEOPLE.map(o=><option key={o}>{o}</option>)}</select> : item.salesperson}</td>
                                <td className="p-2 border-r">{isGridEditable ? <input className="w-full border rounded px-1 text-xs py-1" value={item.salesMemo} onChange={e => handleItemChange(item.id, 'salesMemo', e.target.value)} /> : item.salesMemo}</td>
                                <td className="p-2 border-r">{isGridEditable ? <select className="w-full border rounded px-1 text-xs py-1" value={item.currency} onChange={e => handleItemChange(item.id, 'currency', e.target.value)}>{CURRENCIES.map(c=><option key={c}>{c}</option>)}</select> : item.currency}</td>
                                <td className="p-2 border-r text-right">{isGridEditable ? <input type="number" className="w-full border rounded px-1 text-xs py-1 text-right" value={item.qty} onChange={e => handleItemChange(item.id, 'qty', Number(e.target.value))} /> : item.qty}</td>
                                <td className="p-2 border-r text-right">{isGridEditable ? <input type="number" className="w-full border rounded px-1 text-xs py-1 text-right" value={item.unitPrice} onChange={e => handleItemChange(item.id, 'unitPrice', Number(e.target.value))} /> : new Intl.NumberFormat('en-US').format(item.unitPrice)}</td>
                                <td className="p-2 border-r text-right text-gray-500">
                                    {isGridEditable ? (
                                        <input 
                                            type="number" 
                                            className="w-full border rounded px-1 text-xs py-1 text-right bg-blue-50" 
                                            value={item.twdPrice} 
                                            onChange={e => handleItemChange(item.id, 'twdPrice', Number(e.target.value))} 
                                        />
                                    ) : (
                                        new Intl.NumberFormat('en-US').format(item.twdPrice)
                                    )}
                                </td>
                                <td className="p-2 border-r bg-yellow-50/20 border-l border-yellow-100">{canFinanceAction ? <select className="w-full bg-transparent border-b border-yellow-300 px-1 text-xs py-1" value={item.taxCategory} onChange={e => handleItemChange(item.id, 'taxCategory', e.target.value)}>{TAX_CATEGORIES.map(o=><option key={o}>{o}</option>)}</select> : item.taxCategory}</td>
                                <td className="p-2 border-r bg-yellow-50/20 text-right">{item.taxRate}%</td>
                                <td className="p-2 border-r bg-yellow-50/20">{canFinanceAction ? <input className="w-full bg-transparent border-b border-yellow-300 px-1 text-xs py-1" value={item.financeMemoToSales} onChange={e => handleItemChange(item.id, 'financeMemoToSales', e.target.value)} /> : item.financeMemoToSales}</td>
                                <td className="p-2 border-r bg-yellow-50/20">{canFinanceAction ? <input className="w-full bg-transparent border-b border-yellow-300 px-1 text-xs py-1" value={item.financeMemo} onChange={e => handleItemChange(item.id, 'financeMemo', e.target.value)} /> : item.financeMemo}</td>
                                <td className="p-2 text-right font-bold text-[#E14233] bg-white sticky right-0 z-10 border-l shadow-[-4px_0_4px_-2px_rgba(0,0,0,0.1)]">{new Intl.NumberFormat('en-US').format(item.subtotal)}</td>
                            </tr>
                            ))}
                        </tbody>
                        </table>
                    </div>
                    </div>
                </TelerikWindow>
                {showSmartPaste && <SmartPasteModal onClose={() => setShowSmartPaste(false)} onConfirm={handleSmartPasteConfirm} />}
                
                {showReturnDialog && (
                    <TelerikWindow visible={true} title="退回作業 (Return)" width="400px" onClose={() => setShowReturnDialog(false)} footer={<><TelerikButton onClick={() => setShowReturnDialog(false)}>取消</TelerikButton><TelerikButton themeColor="warning" onClick={confirmReturn}>確認退回</TelerikButton></>}>
                    <div className="flex flex-col gap-2">
                        <label className="text-sm font-bold text-gray-700">請填寫退回原因：</label>
                        <TelerikTextArea value={returnReason} valueChanged={setReturnReason} rows={4} placeholder="例如：單價有誤、缺少 PO 單號..." />
                    </div>
                    </TelerikWindow>
                )}

                {showVoidDialog && (
                    <TelerikWindow visible={true} title="申請作廢 (Request Void)" width="400px" onClose={() => setShowVoidDialog(false)} footer={<><TelerikButton onClick={() => setShowVoidDialog(false)}>取消</TelerikButton><TelerikButton themeColor="error" onClick={confirmVoidRequest}>確認申請</TelerikButton></>}>
                    <div className="flex flex-col gap-2">
                        <label className="text-sm font-bold text-gray-700">請填寫作廢原因：</label>
                        <TelerikTextArea value={voidReason} valueChanged={setVoidReason} rows={4} placeholder="例如：發票開立錯誤、客戶取消訂單..." />
                    </div>
                    </TelerikWindow>
                )}
                </>
            );
        }

        function InvoiceSystem() {
            const [role, setRole] = useState("sales");
            const [requests, setRequests] = useState(INITIAL_DATA);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentRequest, setCurrentRequest] = useState(null);
            const [quickFilter, setQuickFilter] = useState("all");
            const [searchTerm, setSearchTerm] = useState("");

            const filteredData = useMemo(() => {
                return requests.filter(r => {
                let passRole = true;
                if (role === 'sales') {
                    if (quickFilter === 'pending') passRole = r.status === 1 || r.status === 4;
                    if (quickFilter === 'processing') passRole = r.status === 3 || r.status === 5;
                } else {
                    if (r.status < 3) return false;
                    if (quickFilter === 'pending') passRole = r.status === 3 || r.status === 5;
                    if (quickFilter === 'completed') passRole = r.status === 7 || r.status === 4 || r.status === 6;
                }
                if (!passRole) return false;
                if (searchTerm && !r.customerName.includes(searchTerm) && !r.formNumber.includes(searchTerm)) return false;
                return true;
                });
            }, [requests, role, quickFilter, searchTerm]);

            const handleCreate = () => {
                const newReq = {
                id: `req-${Date.now()}`,
                formNumber: "", status: 1, invoiceDate: new Date().toISOString().split('T')[0], customerName: "", invoiceRegion: "國內發票 (Domestic)", memo: "",
                items: [{ id: Date.now(), project: "", workOrder: "", po: "", shipNo: "", item: "", currency: "TWD", qty: 1, unitPrice: 0, twdPrice: 0, subtotal: 0, transactionType: "非出口 (Non-Export)", salesperson: "", salesMemo: "", taxCategory: "應稅 (Taxable)", taxRate: 5, financeMemoToSales: "", financeMemo: "" }],
                finance: { invoiceNo: "", invoicePurpose: "存證發票 (Evidence)", revenueDate: "", buyerNote: "" }
                };
                setCurrentRequest(newReq);
                setIsModalOpen(true);
            };

            const handleEdit = (req) => { setCurrentRequest(JSON.parse(JSON.stringify(req))); setIsModalOpen(true); };
            const handleSave = (req) => {
                let savedReq = { ...req };
                const isNew = !requests.find(r => r.id === req.id);
                if (!savedReq.formNumber && (savedReq.status === 1 || savedReq.status === 3)) savedReq.formNumber = `INV-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${String(requests.length + 1).padStart(3, '0')}`;
                setRequests(isNew ? [savedReq, ...requests] : requests.map(r => r.id === savedReq.id ? savedReq : r));
                setIsModalOpen(false);
            };

            const filterTabs = role === 'sales' ? [ { id: 'all', label: '全部' }, { id: 'pending', label: '待辦事項 (草稿/退回)' }, { id: 'processing', label: '審核中' } ] : [ { id: 'all', label: '全部' }, { id: 'pending', label: '待審核案件' }, { id: 'completed', label: '已處理' } ];
            const gridColumns = [
                { title: "狀態", field: "status", width: "100px", cell: (item) => { const s = STATUS_MAP[item.status]; return <span className={`px-2 py-1 rounded text-xs text-white font-medium ${s.color}`}>{s.label}</span> } },
                { title: "單據編號", field: "formNumber", className: "font-medium text-[#3D57AD]" },
                { title: "發票日期", field: "invoiceDate", width: "120px" },
                { title: "客戶名稱", field: "customerName" },
                { title: "總金額", field: "total", className: "text-right font-bold text-[#E14233]", cell: (item) => new Intl.NumberFormat('zh-TW').format(item.items.reduce((acc, i) => acc + i.subtotal, 0)) },
                { title: "操作", width: "80px", className: "text-center", cell: (item) => <TelerikButton icon={role === 'finance' && (item.status === 3 || item.status === 5) ? Icons.Pencil : Icons.Search} className="p-1 border-none bg-transparent hover:bg-gray-100 text-gray-500" onClick={(e) => { e.stopPropagation(); handleEdit(item); }} /> }
            ];

            return (
                <div className="min-h-screen bg-[#F8F9FA] font-sans text-gray-800 flex flex-col">
                <header className="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
                    <div className="flex items-center gap-2"><div className="bg-[#3D57AD] text-white p-1.5 rounded"><Icons.FileSpreadsheet size={20} /></div><h1 className="text-lg font-bold text-gray-700">Tracy CMS - 電子發票請款系統</h1></div>
                    <div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg border">
                    <button onClick={() => setRole("sales")} className={`px-3 py-1 text-xs rounded transition-all ${role === 'sales' ? 'bg-white shadow text-[#3D57AD] font-bold' : 'text-gray-500'}`}>業務助理</button>
                    <button onClick={() => setRole("finance")} className={`px-3 py-1 text-xs rounded transition-all ${role === 'finance' ? 'bg-white shadow text-[#357D55] font-bold' : 'text-gray-500'}`}>財務人員</button>
                    </div>
                </header>
                <main className="flex-1 p-6 flex flex-col gap-4 overflow-hidden">
                    <div className="flex border-b border-gray-300">{filterTabs.map(tab => <button key={tab.id} onClick={() => setQuickFilter(tab.id)} className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${quickFilter === tab.id ? 'border-[#3D57AD] text-[#3D57AD]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>{tab.label}</button>)}</div>
                    <div className="flex-1 overflow-hidden"><TelerikGrid data={filteredData} columns={gridColumns} onRowClick={handleEdit} toolbar={<>{role === 'sales' && <TelerikButton themeColor="primary" icon={Icons.Plus} onClick={handleCreate}>新增請款</TelerikButton>}<TelerikButton themeColor="success" icon={Icons.FileSpreadsheet}>匯出 Excel</TelerikButton><span className="flex-1"></span><TelerikTextBox placeholder="搜尋..." value={searchTerm} valueChanged={setSearchTerm} className="w-64" /></>} /></div>
                </main>
                {isModalOpen && currentRequest && <InvoiceFormWindow request={currentRequest} role={role} onClose={() => setIsModalOpen(false)} onSave={handleSave} />}
                </div>
            );
        }

        const App = () => <InvoiceSystem />;
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
